<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Regime Allocator</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <style>
      *{box-sizing:border-box}
      :root { --gap: 12px; }
      html,body{overflow-x:hidden}
      body{font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0 auto;max-width:960px;padding:16px;color:#0b1220;background:#fff}
      h1{font-size:1.6rem;margin:0 0 .75rem}
      .card{background:#f6f8fb;border:1px solid #e6eaf0;border-radius:14px;padding:14px;margin:0 0 var(--gap)}
      form{display:grid;gap:var(--gap)}
      fieldset{border:0;padding:0;margin:0;display:grid;gap:10px}
      label{display:flex;flex-direction:column;gap:6px}
      input,select,button,textarea{font:inherit}
      input,select,textarea{padding:.45rem .6rem;border:1px solid #cfd6e4;border-radius:10px;background:#fff;width:100%}
      .row{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:var(--gap)}
      .row-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:var(--gap)}
      @media (max-width: 900px){ .row-3{grid-template-columns:repeat(2,minmax(0,1fr));} }
      @media (max-width: 640px){ .row,.row-3{grid-template-columns:1fr} }
      button{padding:.55rem .9rem;border-radius:10px;border:1px solid #0f62fe;background:#0f62fe;color:#fff;cursor:pointer}
      button.secondary{background:#fff;color:#0f62fe}
      button:disabled{opacity:.6;cursor:not-allowed}
      .hint{font-size:.85rem;color:#5b6a82}
      #out{white-space:pre-wrap;background:#0b1020;color:#d6e1ff;border-radius:12px;padding:12px;overflow:auto;max-height:60vh}
      .error{color:#b00020;white-space:pre-wrap}
      .ok{color:#0a6}
      .grid{display:grid;gap:var(--gap)}
      .two{grid-template-columns:1fr 1fr}
      .pill{display:inline-block;padding:.15rem .45rem;border-radius:999px;background:#e9eef9;color:#233;font-size:.8rem}
      .cards{display:grid;grid-template-columns:1fr;gap:var(--gap)}
      @media (min-width: 860px){ .cards{grid-template-columns:1fr 1fr} }
      .strategy{background:#ffffff;border:1px solid #e6eaf0;border-radius:12px;padding:12px}
      .strategy h3{margin:.2rem 0 .25rem;font-size:1.05rem}
      .strategy p{margin:.2rem 0 .4rem;color:#445}
      .muted{color:#667}
      table{width:100%;border-collapse:collapse}
      th,td{padding:.45rem;border-bottom:1px solid #e6eaf0;text-align:left}
      canvas{max-width:100%}
      .badge{display:inline-block;padding:.2rem .55rem;border-radius:999px;border:1px solid #dfe6f2;font-weight:600}
      .badge.high{background:#fff2e6;border-color:#fde1c2;color:#b54708}
      .badge.low{background:#e7fff6;border-color:#c6f7e2;color:#056449}
      .badge.neutral{background:#eef3ff;border-color:#dfe6ff;color:#0b4}
      .hidden{display:none}
    </style>
  </head>
  <body>
    <h1>Regime Allocator</h1>

    <div class="card">
      <form id="wizard">
        <fieldset class="row">
          <label>Full name <input type="text" name="name" required /></label>
          <label>Age <input type="number" name="age" min="18" max="100" required /></label>
        </fieldset>

        <fieldset class="row-3">
          <label>Liabilities to match?
            <select name="has_liabilities">
              <option value="no" selected>No</option>
              <option value="yes">Yes (use liability-matching first)</option>
            </select>
          </label>
          <label>Investment horizon (years)
            <input type="number" name="horizon" min="1" max="60" />
          </label>
          <label>Primary goal
            <select name="goal">
              <option value="preserve">Preserve capital / low downside</option>
              <option value="retirement" selected>Retirement saving</option>
              <option value="house">Buy a house</option>
              <option value="grow">Maximize long-term wealth</option>
            </select>
          </label>
        </fieldset>

        <fieldset class="row">
          <label>Target year (optional)
            <input type="number" name="target_year" placeholder="e.g. 2035" />
          </label>
          <label>Target amount (optional)
            <input type="number" name="target_amount" placeholder="e.g. 200000" />
          </label>
        </fieldset>

        <fieldset class="row">
          <label>Optimization method
            <select name="method">
              <option value="max_sharpe" selected>Max Sharpe</option>
              <option value="min_var">Min variance</option>
            </select>
          </label>
          <label>Max drawdown (optional, %)
            <input type="number" name="max_drawdown" step="1" min="1" max="90" placeholder="e.g. 20" />
          </label>
        </fieldset>

        <fieldset class="row">
          <label>Beta window (months)
            <input type="number" name="beta_window" value="40" min="6" max="120" />
          </label>
          <label>Cap (0…1, optional)
            <input type="number" name="cap" step="0.05" placeholder="0.30" />
          </label>
        </fieldset>

        <!-- μ MODEL selection -->
        <fieldset class="row-3">
          <label>μ method
            <select name="mu_method" id="mu_method">
              <option value="capm" selected>CAPM</option>
              <option value="ewma">EWMA</option>
              <option value="trailing">Trailing mean</option>
              <option value="var1">VAR(1)</option>
              <option value="arima">ARIMA(1,0,0)</option>
              <option value="histmean">Historical mean</option>
            </select>
          </label>
          <label id="market_col_row">Market column (CAPM)
            <input type="text" name="market_col" id="market_col" value="Global_Equities" />
          </label>
          <label id="capm_window_row">CAPM window (months)
            <input type="number" name="capm_window" id="capm_window" value="60" min="12" max="180" />
          </label>

          <label id="ewma_span_row" class="hidden">EWMA span (months)
            <input type="number" name="ewma_span" id="ewma_span" value="36" min="3" max="120" />
          </label>
          <label id="trailing_window_row" class="hidden">Trailing window (months)
            <input type="number" name="trailing_window" id="trailing_window" value="36" min="6" max="120" />
          </label>
          <label id="var_window_row" class="hidden">VAR window (months)
            <input type="number" name="var_window" id="var_window" value="60" min="24" max="180" />
          </label>
          <label id="arima_order_row" class="hidden">ARIMA order (p,d,q)
            <input type="text" name="arima_order" id="arima_order" value="1,0,0" />
          </label>
        </fieldset>

        <div class="hint">We use your answers to pick a baseline strategy. You can still choose another before computing.</div>
        <div class="row">
          <button type="submit">Recommend a strategy</button>
          <button id="reset" type="button" class="secondary">Reset</button>
        </div>
      </form>
    </div>

    <div id="rec" class="card" style="display:none">
      <h2 style="margin:0 0 .4rem">Recommended strategy</h2>
      <div id="recText" class="hint"></div>
      <div class="cards" id="strategyCards"></div>
      <div class="row" style="margin-top:12px">
        <button id="compute">Compute allocation</button>
        <button id="toggleMore" class="secondary">Show other strategies</button>
      </div>
    </div>

    <div id="macro" class="card" style="display:none">
      <h2 style="margin:0 0 .4rem">Macro context</h2>
      <div class="hint">Current regime: <span id="regimeBadge" class="badge">…</span></div>
      <div style="margin-top:10px">
        <canvas id="cpi" height="150"></canvas>
        <div id="cpiHint" class="hint"></div>
      </div>
    </div>

    <div id="results" class="card" style="display:none">
      <h2 style="margin:0 0 .4rem">Allocation result</h2>
      <div class="hint" id="status"></div>
      <div class="hint" id="muAssumptions" style="margin:.4rem 0 .6rem"></div>
      <div class="grid two">
        <div>
          <canvas id="pie" height="220"></canvas>
        </div>
        <div>
          <table id="weightsTable"><thead><tr><th>Asset</th><th>Weight</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
      <pre id="raw" class="hint" style="margin-top:12px"></pre>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
      // ===== CONFIG =====
      const API = "https://allocator.onrender.com"; // <-- change if needed

      // ===== Strategy cards (simple static choices) =====
      const STRATEGIES = [
        { key:'near_retirement', name:'Near Retirement', rationale:'Drawdown resilience.', params:{ target_vol:0.07, cap:0.25, method:'mv_drawdown', use_norisk:true } },
        { key:'pre_retirement', name:'Pre-Retirement', rationale:'Blend growth & safety.', params:{ target_vol:0.10, cap:0.35, method:'mv_blend', use_norisk:false } },
        { key:'middle_age', name:'Middle Age', rationale:'Balanced growth.', params:{ target_vol:0.12, cap:0.40, method:'mv_growth', use_norisk:false } },
        { key:'young', name:'Young / Early-Career', rationale:'Aggressive growth.', params:{ target_vol:0.16, cap:0.60, method:'half_kelly', use_norisk:false } },
      ];
      function strategyByKey(k){ return STRATEGIES.find(s => s.key===k) || STRATEGIES[0]; }
      function categorize({age,horizon,has_liabilities}){
        if (has_liabilities || (horizon && horizon<=5) || age>=60) return 'near_retirement';
        if ((age>=50 && age<60) || (horizon && horizon<=10)) return 'pre_retirement';
        if ((age>=35 && age<50) || (horizon && horizon<=20)) return 'middle_age';
        return 'young';
      }

      // ===== Elements =====
      const wiz = document.getElementById('wizard');
      const rec = document.getElementById('rec');
      const recText = document.getElementById('recText');
      const strategyCards = document.getElementById('strategyCards');
      const toggleMoreBtn = document.getElementById('toggleMore');
      const computeBtn = document.getElementById('compute');
      const resetBtn = document.getElementById('reset');

      const macro = document.getElementById('macro');
      const regimeBadge = document.getElementById('regimeBadge');
      const cpiHint = document.getElementById('cpiHint');

      const results = document.getElementById('results');
      const statusEl = document.getElementById('status');
      const raw = document.getElementById('raw');
      const weightsTableBody = document.querySelector('#weightsTable tbody');
      const muAssumptions = document.getElementById('muAssumptions');

      const muMethodSel = document.getElementById('mu_method');
      const rows = {
        market_col: document.getElementById('market_col_row'),
        capm_window: document.getElementById('capm_window_row'),
        ewma_span: document.getElementById('ewma_span_row'),
        trailing_window: document.getElementById('trailing_window_row'),
        var_window: document.getElementById('var_window_row'),
        arima_order: document.getElementById('arima_order_row'),
      };

      function updateMuRows(){
        Object.values(rows).forEach(el => el.classList.add('hidden'));
        const m = muMethodSel.value;
        if (m === 'capm') { rows.market_col.classList.remove('hidden'); rows.capm_window.classList.remove('hidden'); }
        else if (m === 'ewma') { rows.ewma_span.classList.remove('hidden'); }
        else if (m === 'trailing') { rows.trailing_window.classList.remove('hidden'); }
        else if (m === 'var1') { rows.var_window.classList.remove('hidden'); }
        else if (m === 'arima') { rows.arima_order.classList.remove('hidden'); }
      }
      muMethodSel.addEventListener('change', updateMuRows);
      updateMuRows();

      function makeCard(s, recommended=false){
        const div = document.createElement('div');
        div.className = 'strategy';
        div.innerHTML = `
          <h3>${s.name} ${recommended ? '<span class="pill">Recommended</span>' : ''}</h3>
          <p class="muted">${s.rationale}</p>
          <div><button data-choose="${s.key}">Use this</button></div>
        `;
        return div;
      }

      function renderStrategies(recKey){
        strategyCards.innerHTML = '';
        STRATEGIES.forEach(s => strategyCards.appendChild(makeCard(s, s.key===recKey)));
        strategyCards.querySelectorAll('button[data-choose]').forEach(btn => {
          btn.addEventListener('click', () => { chosenStrategy = strategyByKey(btn.dataset.choose); });
        });
      }

      let chosenStrategy = null; let showAll = true;
      toggleMoreBtn.addEventListener('click', () => {
        showAll = !showAll;
        if (showAll) renderStrategies(recommendedKey);
        else {
          strategyCards.innerHTML = '';
          strategyCards.appendChild(makeCard(strategyByKey(recommendedKey), true));
        }
      });

      wiz.addEventListener('submit', (e) => {
        e.preventDefault();
        const fd = new FormData(wiz);
        const answers = {
          age: Number(fd.get('age')||0),
          has_liabilities: fd.get('has_liabilities')==='yes',
          horizon: fd.get('horizon') ? Number(fd.get('horizon')) : undefined,
        };
        const recKey = categorize(answers);
        recommendedKey = recKey;
        chosenStrategy = strategyByKey(recKey);
        recText.textContent = `We suggest “${chosenStrategy.name}”.`;
        renderStrategies(recKey);
        rec.style.display = '';
        macro.style.display = '';
        results.style.display = 'none';
        statusEl.textContent = '';
        raw.textContent = '';
        weightsTableBody.innerHTML = '';
        loadMacro();    // load CPI + regime badge
      });

      resetBtn.addEventListener('click', () => {
        wiz.reset();
        updateMuRows();
        rec.style.display = 'none';
        macro.style.display = 'none';
        results.style.display = 'none';
        statusEl.textContent = '';
        raw.textContent = '';
        weightsTableBody.innerHTML = '';
        if (window.cpiChart) { window.cpiChart.destroy(); window.cpiChart = null; }
      });

      // ===== Macro panel =====
      async function loadMacro(){
        try {
          const j = await fetch(`${API}/regime`).then(r=>r.json());
          const reg = (j.current_regime||'').toLowerCase();
          regimeBadge.textContent = (reg||'unknown').toUpperCase();
          regimeBadge.className = `badge ${reg}`;
        } catch {}

        try {
          const r = await fetch(`${API}/cpi`);
          if (!r.ok) throw new Error(String(r.status));
          const j = await r.json();
          const labels = j.dates || [];
          const data = j.yoy || [];
          const ctx = document.getElementById('cpi');
          if (window.cpiChart) window.cpiChart.destroy();
          window.cpiChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label: 'CPI YoY %', data, tension: 0.25 }] },
            options: { plugins: { legend: { position: 'bottom' } }, scales: { y: { title: { display: true, text: '% YoY' } } } }
          });
          cpiHint.textContent = '';
        } catch(err){
          cpiHint.textContent = 'CPI series unavailable.';
        }
      }

      function assumptionsText(p){
        const m = (p.mu_method || '').toLowerCase();
        if (m === 'capm') return `μ: CAPM · market=${p.market_col || 'Global_Equities'} · window=${p.capm_window}m`;
        if (m === 'ewma') return `μ: EWMA · span=${p.ewma_span}m`;
        if (m === 'trailing') return `μ: Trailing mean · window=${p.trailing_window}m`;
        if (m === 'var1') return `μ: VAR(1) · window=${p.var_window}m`;
        if (m === 'arima') return `μ: ARIMA(${(p.arima_order||[]).join(',')})`;
        if (m === 'histmean') return `μ: Historical mean`;
        return `μ: ${m || 'unknown'}`;
      }

      async function tryPost(url, payload){
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), 25000);
        try {
          const res = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload),
            signal: controller.signal
          });
          const text = await res.text();
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${text || '<no body>'}`);
          return JSON.parse(text);
        } finally { clearTimeout(t); }
      }

      function renderTable(weights){
        weightsTableBody.innerHTML = '';
        Object.entries(weights || {}).forEach(([asset, w]) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${asset}</td><td>${(w*100).toFixed(2)}%</td>`;
          weightsTableBody.appendChild(tr);
        });
      }

      let pieChart;
      function renderPie(weights){
        const el = document.getElementById('pie');
        const labels = Object.keys(weights || {});
        const data = Object.values(weights || {}).map(x => Math.max(0, x));
        if (pieChart) pieChart.destroy();
        pieChart = new Chart(el, {
          type: 'pie',
          data: { labels, datasets: [{ data }] },
          options: { plugins: { legend: { position: 'bottom' } } }
        });
      }

      let recommendedKey = null;

      computeBtn.addEventListener('click', async () => {
        try{
          const fd = new FormData(wiz);
          const has_liabilities = fd.get('has_liabilities') === 'yes';
          const payload = {
            beta_window: Number(fd.get('beta_window')||40),
            periods_per_year: 12,
            t_threshold: 2.0,
            t_mode: 'linear',
            fixed_start_date: '2012-01-31',
            drop_assets: [],
            cap: fd.get('cap') ? Number(fd.get('cap')) : undefined,
            // μ
            mu_method: fd.get('mu_method') || 'capm',
            market_col: fd.get('market_col') || 'Global_Equities',
            capm_window: Number(fd.get('capm_window') || 60),
            ewma_span: Number(fd.get('ewma_span') || 36),
            trailing_window: Number(fd.get('trailing_window') || 36),
            var_window: Number(fd.get('var_window') || 60),
            arima_order: (fd.get('arima_order') || '1,0,0').split(',').map(s=>Number(s.trim())),
          };

          results.style.display = '';
          statusEl.className = 'hint';
          statusEl.textContent = 'Computing…';
          muAssumptions.textContent = assumptionsText(payload);
          raw.textContent = '';
          weightsTableBody.innerHTML = '';

          const json = await tryPost(`${API}/allocate`, payload);
          if (!json || !json.weights) throw new Error('No weights returned from API.');

          renderTable(json.weights);
          renderPie(json.weights);
          raw.textContent = JSON.stringify(json, null, 2);
          statusEl.textContent = 'Done.';
          statusEl.className = 'ok';
          loadMacro(); // optional refresh
        } catch (err){
          console.error(err);
          statusEl.textContent = String(err.message || err);
          statusEl.className = 'error';
        }
      });
    </script>
  </body>
</html>
